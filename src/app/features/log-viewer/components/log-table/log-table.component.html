<div class="table-container" (click)="closeFilterDropdown()">
  <!-- Table controls -->
  <div class="table-controls">
    <button class="control-btn" (click)="toggleTimezone()">
      {{ useUTC() ? 'UTC' : 'Local' }}
    </button>
    <div class="column-menu-wrapper">
      <button class="control-btn" (click)="toggleColumnMenu()">Columns</button>
      @if (showColumnMenu()) {
        <div class="column-menu">
          @for (col of columns(); track col.key) {
            <label class="column-option">
              <input
                type="checkbox"
                [checked]="col.visible"
                (change)="toggleColumn(col.key)" />
              {{ col.label }}
            </label>
          }
        </div>
      }
    </div>
  </div>

  <!-- Table header -->
  <div class="table-header">
    @for (col of visibleColumns; track col.key) {
      <div class="header-cell"
           [class.filterable]="col.filterable"
           [class.has-active-filter]="hasActiveFilter(col.key)"
           [style.width.px]="col.flex ? null : col.width"
           [style.flex]="col.flex ? '1 1 0' : null"
           [style.min-width.px]="col.minWidth">

        <!-- Timestamp column with sort -->
        @if (col.key === 'timestamp') {
          <span class="header-label" (click)="toggleSort()">
            {{ col.label }}
            <span class="sort-icon">{{ state.sortDirection() === 'asc' ? '▲' : '▼' }}</span>
          </span>
        } @else if (col.filterable) {
          <!-- Filterable column header -->
          <span class="header-label" (click)="toggleFilterDropdown(col.key, $event)">
            {{ col.label }}
            <svg class="filter-icon" [class.active]="hasActiveFilter(col.key)" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2h14l-5.5 6.5V14l-3-2v-3.5z"/></svg>
          </span>

          <!-- Filter dropdown -->
          @if (openFilterColumn() === col.key) {
            <div class="column-filter-dropdown" (click)="$event.stopPropagation()">
              @switch (col.key) {
                @case ('severity') {
                  @for (sev of availableSeverities(); track sev) {
                    <label class="filter-option">
                      <input type="checkbox"
                             [checked]="isFilterValueActive('severity', sev)"
                             (change)="toggleColumnFilter('severity', sev)" />
                      <span class="severity-tag" [class]="'severity-' + sev.toLowerCase()">{{ sev }}</span>
                    </label>
                  }
                }
                @case ('service') {
                  @for (svc of availableServices(); track svc) {
                    <label class="filter-option">
                      <input type="checkbox"
                             [checked]="isFilterValueActive('service', svc)"
                             (change)="toggleColumnFilter('service', svc)" />
                      {{ svc }}
                    </label>
                  }
                }
                @case ('httpMethod') {
                  @for (method of availableMethods(); track method) {
                    <label class="filter-option">
                      <input type="checkbox"
                             [checked]="isFilterValueActive('httpMethod', method)"
                             (change)="toggleColumnFilter('httpMethod', method)" />
                      {{ method }}
                    </label>
                  }
                }
                @case ('httpPath') {
                  <input
                    type="text"
                    class="path-filter-input"
                    placeholder="Filter path..."
                    [value]="getPathFilterValue()"
                    (input)="onPathFilterInput($any($event.target).value)"
                    (click)="$event.stopPropagation()" />
                }
                @case ('httpStatus') {
                  @for (cat of availableStatusCategories; track cat) {
                    <label class="filter-option">
                      <input type="checkbox"
                             [checked]="isFilterValueActive('httpStatus', cat)"
                             (change)="toggleColumnFilter('httpStatus', cat)" />
                      <span [class]="'status-' + cat">{{ cat }}</span>
                    </label>
                  }
                }
              }
            </div>
          }
        } @else {
          <span class="header-label">{{ col.label }}</span>
        }

        <!-- Resize handle -->
        <div class="resize-handle" (mousedown)="onResizeStart($event, col.key)"></div>
      </div>
    }
    <div class="header-cell col-actions"></div>
  </div>

  <!-- Virtual scroll viewport -->
  <cdk-virtual-scroll-viewport
    [itemSize]="36"
    class="table-viewport">
    <div
      *cdkVirtualFor="let record of state.filteredRecords(); trackBy: trackByRecord"
      class="table-row-wrapper">

      <div
        class="table-row"
        [class]="severityClass(record)"
        [class.expanded]="isExpanded(record)"
        (click)="toggleRow(record)">

        @for (col of visibleColumns; track col.key) {
          <div class="cell"
               [style.width.px]="col.flex ? null : col.width"
               [style.flex]="col.flex ? '1 1 0' : null"
               [style.min-width.px]="col.minWidth">
            @switch (col.key) {
              @case ('timestamp') {
                <span class="mono">{{ formatTimestamp(record.timestamp) }}</span>
              }
              @case ('severity') {
                <span class="severity-tag" [class]="severityClass(record)">
                  {{ record.severityText }}
                </span>
              }
              @case ('service') {
                {{ getServiceDisplay(record) }}
              }
              @case ('message') {
                <span class="message-text" [title]="record.message">{{ record.message }}</span>
              }
              @case ('httpMethod') {
                <span class="mono">{{ record.httpMethod ?? '' }}</span>
              }
              @case ('httpPath') {
                <span class="mono path-text" [title]="record.httpPath ?? ''">{{ record.httpPath ?? '' }}</span>
              }
              @case ('httpStatus') {
                @if (record.httpStatusCode) {
                  <span class="status-code" [class]="statusClass(record.httpStatusCode)">
                    {{ record.httpStatusCode }}
                  </span>
                }
              }
            }
          </div>
        }

        <div class="cell col-actions">
          <button class="copy-btn" (click)="copyRecord(record, $event)" title="Copy JSON">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          </button>
        </div>
      </div>

      @if (isExpanded(record)) {
        <app-log-detail [record]="record" />
      }
    </div>
  </cdk-virtual-scroll-viewport>
</div>
